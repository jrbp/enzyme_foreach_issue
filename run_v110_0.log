Julia: v1.10.0
Project enzyme_test v0.1.0
Status `~/git/temp/enzyme_foreach/Project.toml`
⌃ [b0b7db55] ComponentArrays v0.15.14
⌃ [7da242da] Enzyme v0.12.22
  [37e2e46d] LinearAlgebra
  [9a3f8284] Random
Info Packages marked with ⌃ have new versions available and may be upgradable.

15
16
17
18
19
20
Complicated cases which succeeded
Here foreach is only used where it does not cause activity errors
for, primal run
  0.002100 seconds (241 allocations: 10.641 KiB)
  0.002535 seconds (241 allocations: 10.641 KiB)
  0.002867 seconds (241 allocations: 10.641 KiB)
  0.003370 seconds (241 allocations: 10.641 KiB)
  0.003789 seconds (241 allocations: 10.641 KiB)
  0.004110 seconds (241 allocations: 10.641 KiB)
foreach, primal run
  0.002075 seconds (40 allocations: 960 bytes)
  0.002422 seconds (40 allocations: 960 bytes)
  0.002859 seconds (40 allocations: 960 bytes)
  0.003274 seconds (40 allocations: 960 bytes)
  0.003581 seconds (40 allocations: 960 bytes)
  0.004156 seconds (40 allocations: 960 bytes)

for, grad run
  0.034492 seconds (8.79 k allocations: 441.406 KiB)
  0.038782 seconds (8.80 k allocations: 444.391 KiB)
  0.047393 seconds (8.80 k allocations: 444.391 KiB)
  0.052212 seconds (8.80 k allocations: 444.391 KiB)
  0.056920 seconds (8.80 k allocations: 444.391 KiB)
  0.068115 seconds (8.80 k allocations: 444.391 KiB)
foreach, grad run
  0.047256 seconds (24.89 k allocations: 10.887 MiB)
  0.055882 seconds (25.61 k allocations: 12.744 MiB)
  0.075258 seconds (26.10 k allocations: 13.936 MiB)
  0.067097 seconds (26.31 k allocations: 14.597 MiB)
  0.077172 seconds (27.57 k allocations: 18.564 MiB)
  0.087624 seconds (27.78 k allocations: 19.225 MiB)

for, primal comp
  2.334561 seconds (3.97 M allocations: 269.904 MiB, 2.15% gc time)
  0.433320 seconds (585.09 k allocations: 38.887 MiB, 3.80% gc time)
  0.454583 seconds (585.10 k allocations: 39.132 MiB, 5.20% gc time)
  0.475105 seconds (585.10 k allocations: 38.893 MiB)
  0.443804 seconds (585.11 k allocations: 38.927 MiB, 4.57% gc time)
  0.474128 seconds (585.09 k allocations: 38.878 MiB, 4.61% gc time)
foreach, primal comp
  1.063821 seconds (1.70 M allocations: 109.069 MiB, 2.09% gc time)
  0.222974 seconds (196.43 k allocations: 12.544 MiB)
  0.243291 seconds (196.43 k allocations: 12.552 MiB)
  0.246470 seconds (196.43 k allocations: 12.547 MiB)
  0.221115 seconds (196.42 k allocations: 12.543 MiB)
  0.248747 seconds (196.43 k allocations: 12.552 MiB)

note: first gradient comp always takes longer
for, grad comp
 30.742881 seconds (52.92 M allocations: 3.267 GiB, 2.43% gc time)
  5.773628 seconds (9.65 M allocations: 588.456 MiB, 2.21% gc time)
  6.196505 seconds (9.68 M allocations: 590.189 MiB, 2.04% gc time)
  6.459069 seconds (9.70 M allocations: 590.527 MiB, 2.58% gc time)
  5.959131 seconds (9.73 M allocations: 591.532 MiB, 2.11% gc time)
  7.115892 seconds (9.76 M allocations: 592.872 MiB, 12.26% gc time)
foreach, grad comp
 35.136787 seconds (48.26 M allocations: 2.501 GiB, 2.43% gc time)
 32.004390 seconds (38.93 M allocations: 1.869 GiB, 2.95% gc time)
 34.180914 seconds (39.03 M allocations: 1.873 GiB, 1.34% gc time)
 34.663255 seconds (39.12 M allocations: 1.877 GiB, 1.35% gc time)
 31.739699 seconds (39.21 M allocations: 1.884 GiB, 1.30% gc time)
 33.002149 seconds (39.29 M allocations: 1.892 GiB, 1.47% gc time)


Simple foreach/sum cases which work:
simple run  for    : 0.000000 seconds
simple run  for    : 0.000000 seconds
simple run  foreach: 0.000003 seconds (21 allocations: 336 bytes)
simple run  foreach: 0.000001 seconds (21 allocations: 336 bytes)
simple run  sum    : 0.000000 seconds
simple run  sum    : 0.000000 seconds
simple grad for    : 0.000001 seconds
simple grad for    : 0.000000 seconds
simple grad foreach: 0.865845 seconds (402.80 k allocations: 27.313 MiB, 99.98% compilation time)
simple grad foreach: 0.000042 seconds (87 allocations: 4.219 KiB)
simple grad sum    : 0.000001 seconds
simple grad sum    : 0.000000 seconds

foreach/sum cases which fail:
all foreach primal: 2.237952 seconds (3.58 M allocations: 238.296 MiB, 2.39% gc time, 99.97% compilation time)
all foreach primal: 0.000228 seconds (80 allocations: 1.562 KiB)
all foreach , gradient failed for Base.Pairs{Symbol, Any, NTuple{6, Symbol}, @NamedTuple{seed::Int64, lnn::Int64, nk::Int64, nbs::Int64, nd::Int64, lovary::UnitRange{Int64}}}(:seed => 123, :lnn => 3, :nk => 20, :nbs => 5, :nd => 5, :lovary => 0:9) with Enzyme.Compiler.EnzymeRuntimeException(Cstring(0x000078d85b37f5d4))
all foreach , gradient failed for Base.Pairs{Symbol, Any, NTuple{6, Symbol}, @NamedTuple{seed::Int64, lnn::Int64, nk::Int64, nbs::Int64, nd::Int64, lovary::UnitRange{Int64}}}(:seed => 123, :lnn => 3, :nk => 20, :nbs => 5, :nd => 5, :lovary => 0:9) with Enzyme.Compiler.EnzymeRuntimeException(Cstring(0x000078d85b37f5d4))
sum + rest foreach primal: 0.093391 seconds (78.29 k allocations: 5.349 MiB, 99.77% compilation time)
sum + rest foreach, gradient failed for Base.Pairs{Symbol, Any, NTuple{6, Symbol}, @NamedTuple{seed::Int64, lnn::Int64, nk::Int64, nbs::Int64, nd::Int64, lovary::UnitRange{Int64}}}(:seed => 123, :lnn => 3, :nk => 20, :nbs => 5, :nd => 5, :lovary => 0:9) with Enzyme.Compiler.EnzymeRuntimeException(Cstring(0x000078d85b39c6e8))
